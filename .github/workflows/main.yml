name: Sync Upstream and Process Configuration

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 0 ç‚¹è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 8 ç‚¹ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync-and-process:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€è¦å†™å…¥ä»“åº“å†…å®¹
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # èŽ·å–æ‰€æœ‰åŽ†å²è®°å½•

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/qist/tvbox.git
          git fetch upstream

      - name: Merge upstream changes
        run: |
          # å°è¯•åˆå¹¶ä¸Šæ¸¸çš„mainåˆ†æ”¯
          git checkout main
          git merge upstream/main --allow-unrelated-histories --no-edit || true
          
          # å¦‚æžœæœ‰å†²çªï¼Œä½¿ç”¨ä¸Šæ¸¸çš„ç‰ˆæœ¬
          if git status --porcelain | grep -q "^UU"; then
            echo "æ£€æµ‹åˆ°å†²çªï¼Œä½¿ç”¨ä¸Šæ¸¸ç‰ˆæœ¬..."
            git checkout --theirs -- .
            git add .
            git commit -m "è§£å†³å†²çªï¼šä½¿ç”¨ä¸Šæ¸¸ç‰ˆæœ¬ [$(date +'%Y-%m-%d %H:%M:%S')]" || true
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Process configuration with custom settings
        run: |
          cat > process_with_custom.py << 'EOF'
          #!/usr/bin/env python3
          """
          å¤„ç†é…ç½®å¹¶åº”ç”¨è‡ªå®šä¹‰è®¾ç½®ï¼š
          1. è¯»å–ä¸Šæ¸¸çš„dianshi.json
          2. åº”ç”¨ç”¨æˆ·çš„è‡ªå®šä¹‰é…ç½®ï¼ˆå›½å†…å¹³å°+ç¬¬ä¸‰æ–¹è§£æžï¼‰
          3. è½¬æ¢è·¯å¾„åˆ°ç”¨æˆ·ä»“åº“
          4. ç”Ÿæˆæœ€ç»ˆçš„dianshi.json
          """
          import json
          import sys
          import os
          from urllib.parse import urljoin

          # ç”¨æˆ·çš„æ ¸å¿ƒé…ç½®ï¼ˆå…³é”®éƒ¨åˆ†ï¼‰
          USER_CORE_CONFIG = {
              "sites": [
                  # 6ä¸ªå…³é”®ç«™ç‚¹ - å›½å†…å¹³å°JSé©±åŠ¨
                  {
                      "key": "drpy_js_ä¼˜é…·",
                      "name": "å®˜æº | ä¼˜é…·[js]",
                      "type": 3,
                      "api": "./lib/drpy2.min.js",
                      "ext": "./js/ä¼˜é…·.js"
                  },
                  {
                      "key": "drpy_js_è…¾äº‘é©¾é›¾",
                      "name": "å®˜æº | è…¾è®¯[js]",
                      "type": 3,
                      "api": "./lib/drpy2.min.js",
                      "ext": "./js/è…¾äº‘é©¾é›¾.js"
                  },
                  {
                      "key": "drpy_js_ç™¾å¿™æ— æžœ",
                      "name": "å®˜æº | èŠ’æžœ[js]",
                      "type": 3,
                      "api": "./lib/drpy2.min.js",
                      "ext": "./js/ç™¾å¿™æ— æžœ.js"
                  },
                  {
                      "key": "drpy_js_èœç‹—",
                      "name": "å®˜æº | æœç‹—[js]",
                      "type": 3,
                      "api": "./lib/drpy2.min.js",
                      "ext": "./js/èœç‹—.js"
                  },
                  {
                      "key": "drpy_js_360å½±è§†",
                      "name": "å®˜æº | 360[js]",
                      "type": 3,
                      "api": "./lib/drpy2.min.js",
                      "ext": "./js/360å½±è§†.js"
                  },
                  {
                      "key": "drpy_js_å¥‡çå¼‚å…½",
                      "name": "å®˜æº | çˆ±å¥‡è‰º[js]",
                      "type": 3,
                      "api": "./lib/drpy2.min.js",
                      "ext": "./js/å¥‡çå¼‚å…½.js"
                  }
              ],
              "parses": [
                  # æ ¸å¿ƒè§£æžæŽ¥å£ - ç¡®ä¿ä½¿ç”¨ç¬¬ä¸‰æ–¹è§£æž
                  {"name": "Jsonèšåˆ", "type": 3, "url": "Demo"},
                  {"name": "jx", "type": 0, "url": "https://jx.m3u8.tv/jx/jx.php?url="},
                  {"name": "ç¾½è·¯å‡æ²¾", "type": 0, "url": "https://ylu.cc/index.php?url="},
                  {"name": "999", "type": 0, "url": "https://huayong.net/999/?v="},
                  {"name": "jx5", "type": 0, "url": "https://huayong.net/jx5/?url="},
                  {"name": "æ— å°½", "type": 0, "url": "https://jx.wujinkk.com/dplayer/?url=", "ext": {"header": {"User-Agent": "Mozilla/5.0"}}},
                  {"name": "yemu", "type": 0, "url": "https://www.yemu.xyz/?url="},
                  {"name": "è§£æž1", "type": 0, "url": "https://bd.jx.cn/?url="},
                  {"name": "è§£æž2", "type": 0, "url": "https://jx.m3u8.tv/jiexi/?url="},
                  {"name": "è§£æž3", "type": 0, "url": "https://player.mrgaocloud.com/player/?url="},
                  {"name": "vip4", "type": 0, "url": "https://huayong.net/vip4/?url="},
                  {"name": "å…è´¹åˆ†äº«", "type": 0, "url": "https://jx.xmflv.com/?url=", "ext": {"flag": ["qq", "è…¾è®¯", "qiyi", "çˆ±å¥‡è‰º", "å¥‡è‰º", "youku", "ä¼˜é…·", "mgtv", "èŠ’æžœ", "imgo", "letv", "ä¹è§†", "pptv", "PPTV", "sohu", "bilibili", "å“”å“©å“”å“©", "å“”å“©"], "header": {"User-Agent": "okhttp/4.1.0"}}},
                  {"name": "å…¨æ°‘", "url": "http://api.wpsseo.cn/?v=", "type": 0, "ext": {"flag": ["qiyi", "imgo", "çˆ±å¥‡è‰º", "å¥‡è‰º", "qq", "è…¾è®¯", "youku", "ä¼˜é…·", "pptv", "PPTV", "letv", "ä¹è§†", "leshi", "bilibili", "å“”å“©å“”å“©", "å“”å“©", "mgtv", "èŠ’æžœ", "sohu", "xigua", "fun", "é£Žè¡Œ"], "header": {"User-Agent": "Mozilla/5.0"}}}
              ],
              "flags": ["youku", "ä¼˜é…·", "ä¼˜ é…·", "ä¼˜é…·è§†é¢‘", "qq", "è…¾è®¯", "è…¾ è®¯", "è…¾è®¯è§†é¢‘", "iqiyi", "qiyi", "å¥‡è‰º", "çˆ±å¥‡è‰º", "çˆ± å¥‡ è‰º", "m1905", "xigua", "letv", "leshi", "ä¹è§†", "ä¹ è§†", "sohu", "æœç‹", "æœ ç‹", "æœç‹è§†é¢‘", "tudou", "mgtv", "èŠ’æžœ", "imgo", "èŠ’æžœTV", "èŠ’ æžœ T V", "bilibili", "å“” å“©", "å“” å“© å“” å“©", "SPA", "YuMi-vip", "pptv", "PPTV", "ltnb", "rx", "SLYS4k", "tucheng", "BYGA", "luanzi", "dxzy", "QEYSS", "aliyun", "AliS", "122", "chuangying", "CL4K", "xfyun", "wuduzy", "wasu", "renrenmi", "ppayun", "haiwaikan", "cool", "dbm3u8", "xmm", "funshion", "ruyi1080", "ruyib1080"]
          }

          def load_config(file_path):
              """ä»Žæ–‡ä»¶åŠ è½½é…ç½®"""
              with open(file_path, 'r', encoding='utf-8') as f:
                  return json.load(f)
          
          def save_config(config, file_path):
              """ä¿å­˜é…ç½®åˆ°æ–‡ä»¶"""
              with open(file_path, 'w', encoding='utf-8', newline='\n') as f:
                  json.dump(config, f, ensure_ascii=False, indent=2)
          
          def merge_configs(upstream_config, user_core):
              """åˆå¹¶ä¸Šæ¸¸é…ç½®å’Œç”¨æˆ·æ ¸å¿ƒé…ç½®"""
              merged = upstream_config.copy()
              
              # ç¡®ä¿å…³é”®ç«™ç‚¹åœ¨å‰é¢
              if 'sites' in upstream_config and 'sites' in user_core:
                  # èŽ·å–ç”¨æˆ·çš„æ ¸å¿ƒç«™ç‚¹
                  core_sites = user_core['sites']
                  core_keys = [site['key'] for site in core_sites if 'key' in site]
                  
                  # ä»Žä¸Šæ¸¸é…ç½®ä¸­ç§»é™¤é‡å¤çš„æ ¸å¿ƒç«™ç‚¹
                  upstream_sites = []
                  for site in upstream_config['sites']:
                      if 'key' in site and site['key'] in core_keys:
                          continue  # è·³è¿‡ï¼Œç”¨ç”¨æˆ·çš„ç‰ˆæœ¬æ›¿æ¢
                      upstream_sites.append(site)
                  
                  # åˆå¹¶ï¼šç”¨æˆ·æ ¸å¿ƒç«™ç‚¹åœ¨å‰ï¼Œç„¶åŽæ˜¯å…¶ä»–ç«™ç‚¹
                  merged['sites'] = core_sites + upstream_sites
              
              # åˆå¹¶è§£æžæŽ¥å£ï¼ˆç¡®ä¿ç”¨æˆ·çš„æ ¸å¿ƒè§£æžæŽ¥å£åœ¨å‰é¢ï¼‰
              if 'parses' in user_core:
                  user_parses = user_core['parses']
                  if 'parses' in upstream_config:
                      # åŽ»é‡åˆå¹¶
                      existing_urls = {p.get('url', '') for p in user_parses}
                      additional_parses = []
                      for parse in upstream_config['parses']:
                          if parse.get('url', '') not in existing_urls:
                              additional_parses.append(parse)
                      merged['parses'] = user_parses + additional_parses
                  else:
                      merged['parses'] = user_parses
              
              # åˆå¹¶flags
              if 'flags' in user_core and 'flags' in upstream_config:
                  merged['flags'] = list(set(user_core['flags'] + upstream_config['flags']))
              
              return merged
          
          def convert_paths_for_user_repo(config, user_repo="city10666/tvbox-ayt"):
              """è½¬æ¢è·¯å¾„åˆ°ç”¨æˆ·ä»“åº“"""
              def is_url(s: str) -> bool:
                  return isinstance(s, str) and s.startswith(('http://', 'https://', 'ftp://', '//'))
              
              def convert_path(path: str) -> str:
                  if not isinstance(path, str):
                      return path
                  if is_url(path):
                      # å¦‚æžœå·²ç»æ˜¯å®Œæ•´URLï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯ä¸Šæ¸¸ä»“åº“çš„URL
                      if 'raw.githubusercontent.com/qist/tvbox' in path:
                          # æ›¿æ¢ä¸ºç”¨æˆ·çš„ä»“åº“
                          return path.replace('qist/tvbox', user_repo)
                      return path
                  if path.startswith('./'):
                      path = path[2:]
                  # è½¬æ¢ä¸ºç”¨æˆ·ä»“åº“çš„URL
                  base_url = f"https://raw.githubusercontent.com/{user_repo}/main/"
                  if ';' in path:
                      parts = path.split(';')
                      converted = urljoin(base_url, parts[0])
                      return ';'.join([converted] + parts[1:])
                  else:
                      return urljoin(base_url, path)
              
              def transform_obj(obj):
                  if isinstance(obj, dict):
                      for key, val in obj.items():
                          # è·³è¿‡æŸäº›å­—æ®µ
                          if key in ['ua', 'User-Agent']:
                              continue
                          obj[key] = transform_obj(val)
                      return obj
                  elif isinstance(obj, list):
                      return [transform_obj(item) for item in obj]
                  elif isinstance(obj, str):
                      if obj.startswith('./'):
                          return convert_path(obj)
                      # æ£€æŸ¥æ˜¯å¦åŒ…å«ä¸Šæ¸¸ä»“åº“çš„URL
                      if 'raw.githubusercontent.com/qist/tvbox' in obj:
                          return obj.replace('qist/tvbox', user_repo)
                      return obj
                  else:
                      return obj
              
              return transform_obj(config)
          
          def main():
              # è¾“å…¥æ–‡ä»¶ï¼ˆä¸Šæ¸¸çš„dianshi.jsonï¼‰
              input_file = "dianshi.json"
              output_file = "dianshi_processed.json"
              
              if not os.path.exists(input_file):
                  print(f"é”™è¯¯: è¾“å…¥æ–‡ä»¶ {input_file} ä¸å­˜åœ¨")
                  sys.exit(1)
              
              # åŠ è½½ä¸Šæ¸¸é…ç½®
              print(f"ä»Ž {input_file} åŠ è½½ä¸Šæ¸¸é…ç½®...")
              upstream_config = load_config(input_file)
              
              # åˆå¹¶é…ç½®
              print("åº”ç”¨ç”¨æˆ·è‡ªå®šä¹‰é…ç½®...")
              merged_config = merge_configs(upstream_config, USER_CORE_CONFIG)
              
              # è½¬æ¢è·¯å¾„åˆ°ç”¨æˆ·ä»“åº“
              print("è½¬æ¢è·¯å¾„åˆ°ç”¨æˆ·ä»“åº“...")
              final_config = convert_paths_for_user_repo(merged_config)
              
              # ä¿å­˜æœ€ç»ˆé…ç½®
              save_config(final_config, output_file)
              
              # è¾“å‡ºç»Ÿè®¡ä¿¡æ¯
              print(f"\nâœ… é…ç½®å¤„ç†å®Œæˆï¼Œè¾“å‡ºåˆ° {output_file}")
              print(f"ðŸ“Š æœ€ç»ˆé…ç½®ç»Ÿè®¡:")
              print(f"  ç«™ç‚¹æ€»æ•°: {len(final_config.get('sites', []))}")
              print(f"  è§£æžæŽ¥å£æ€»æ•°: {len(final_config.get('parses', []))}")
              print(f"  è§„åˆ™æ•°é‡: {len(final_config.get('rules', []))}")
              print(f"  å¹¿å‘Šè¿‡æ»¤æ•°é‡: {len(final_config.get('ads', []))}")
              
              # æ˜¾ç¤ºå…³é”®ç«™ç‚¹
              sites = final_config.get('sites', [])
              if sites:
                  print(f"\nðŸ”‘ å…³é”®ç«™ç‚¹ï¼ˆå‰6ä¸ªï¼‰:")
                  for i in range(min(6, len(sites))):
                      site = sites[i]
                      key = site.get('key', 'æ— key')
                      name = site.get('name', 'æ— name')
                      api = site.get('api', 'æ— api')
                      print(f"  {i+1}. {key} - {name}")
                      print(f"      APIè·¯å¾„: {api[:80]}...")
              
              # æ˜¾ç¤ºè§£æžæŽ¥å£
              parses = final_config.get('parses', [])
              if parses:
                  print(f"\nðŸ”§ è§£æžæŽ¥å£ï¼ˆå‰5ä¸ªï¼‰:")
                  for i in range(min(5, len(parses))):
                      parse = parses[i]
                      parse_name = parse.get('name', 'æ— å')
                      parse_url = parse.get('url', 'æ— url')
                      print(f"  {i+1}. {parse_name} - {parse_url[:50]}...")
              
              # æ£€æŸ¥è·¯å¾„è½¬æ¢
              print(f"\nðŸ”— è·¯å¾„è½¬æ¢æ£€æŸ¥:")
              if sites:
                  sample_site = sites[0]
                  if 'api' in sample_site:
                      api_path = sample_site['api']
                      if 'city10666/tvbox-ayt' in api_path:
                          print(f"  âœ… APIè·¯å¾„å·²æ­£ç¡®è½¬æ¢åˆ°ç”¨æˆ·ä»“åº“")
                      else:
                          print(f"  âš ï¸ APIè·¯å¾„å¯èƒ½æœªè½¬æ¢: {api_path[:80]}...")
          
          if __name__ == '__main__':
              main()
          EOF

          # è¿è¡Œå¤„ç†è„šæœ¬
          python process_with_custom.py

      - name: Replace original dianshi.json with processed version
        run: |
          echo "æ›¿æ¢åŽŸå§‹dianshi.jsonä¸ºå¤„ç†åŽçš„ç‰ˆæœ¬..."
          if [ -f dianshi_processed.json ]; then
            mv dianshi_processed.json dianshi.json
            echo "âœ… å·²æ›¿æ¢dianshi.json"
          else
            echo "âŒ é”™è¯¯: dianshi_processed.json æ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi

      - name: Verify the final configuration
        run: |
          echo "éªŒè¯æœ€ç»ˆé…ç½®æ–‡ä»¶..."
          if [ -f dianshi.json ]; then
            echo "âœ… dianshi.json ç”ŸæˆæˆåŠŸ"
            echo "ðŸ“‹ æ–‡ä»¶ä¿¡æ¯:"
            ls -lh dianshi.json
            echo ""
            echo "ðŸ” é…ç½®æ‘˜è¦:"
            python -c "
import json
try:
    with open('dianshi.json', 'r', encoding='utf-8') as f:
        config = json.load(f)
    
    print('1. åŒæ­¥å’Œè‡ªå®šä¹‰æ£€æŸ¥:')
    print(f'   - æ˜¯å¦åŒ…å«ä¼˜é…·ç«™ç‚¹: {\"drpy_js_ä¼˜é…·\" in [s.get(\"key\", \"\") for s in config.get(\"sites\", [])]}')
    print(f'   - æ˜¯å¦åŒ…å«è…¾è®¯ç«™ç‚¹: {\"drpy_js_è…¾äº‘é©¾é›¾\" in [s.get(\"key\", \"\") for s in config.get(\"sites\", [])]}')
    print(f'   - æ˜¯å¦åŒ…å«çˆ±å¥‡è‰ºç«™ç‚¹: {\"drpy_js_å¥‡çå¼‚å…½\" in [s.get(\"key\", \"\") for s in config.get(\"sites\", [])]}')
    print(f'   - è§£æžæŽ¥å£æ•°é‡: {len(config.get(\"parses\", []))}')
    
    print('\\n2. è·¯å¾„è½¬æ¢éªŒè¯:')
    sites = config.get('sites', [])
    if sites:
        sample_site = sites[0]
        if 'api' in sample_site:
            api_path = sample_site['api']
            if 'city10666/tvbox-ayt' in api_path:
                print(f'   âœ… APIè·¯å¾„å·²æ­£ç¡®è½¬æ¢åˆ°ç”¨æˆ·ä»“åº“')
                print(f'      ç¤ºä¾‹: {api_path[:100]}...')
            else:
                print(f'   âš ï¸ APIè·¯å¾„å¯èƒ½æœªè½¬æ¢: {api_path[:100]}...')
    
    print('\\n3. é…ç½®å®Œæ•´æ€§:')
    required_keys = ['sites', 'parses', 'flags', 'rules', 'ads', 'doh']
    for key in required_keys:
        has_key = key in config
        count = len(config.get(key, [])) if has_key else 0
        print(f'   - {key}: {has_key} ({count} é¡¹)')
    
    print('\\n4. ç«™ç‚¹æŽ’åºæ£€æŸ¥:')
    if sites:
        print(f'   å‰6ä¸ªç«™ç‚¹çš„key:')
        for i in range(min(6, len(sites))):
            key = sites[i].get('key', 'æ— key')
            name = sites[i].get('name', 'æ— name')
            print(f'     {i+1}. {key} - {name[:30]}...')
        
except Exception as e:
    print(f'éªŒè¯é”™è¯¯: {e}')
"
          else
            echo "âŒ é”™è¯¯: dianshi.json æ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi

      - name: Commit and push all changes
        run: |
          echo "æäº¤æ‰€æœ‰æ›´æ”¹..."
          git add .
          if git diff --cached --quiet; then
            echo "æ²¡æœ‰æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
          else
            git commit -m "åŒæ­¥ä¸Šæ¸¸ä»“åº“å¹¶åº”ç”¨è‡ªå®šä¹‰é…ç½® [$(date +'%Y-%m-%d %H:%M:%S')]
            
            - åŒæ­¥ä¸Šæ¸¸ qist/tvbox ä»“åº“
            - åº”ç”¨è‡ªå®šä¹‰é…ç½®ï¼ˆä¼˜é…·ã€è…¾è®¯ç­‰6ä¸ªå›½å†…å¹³å°ï¼‰
            - ä½¿ç”¨ç¬¬ä¸‰æ–¹è§£æžæŽ¥å£
            - è½¬æ¢è·¯å¾„åˆ°ç”¨æˆ·ä»“åº“"
            git push origin main
            echo "âœ… å·²æˆåŠŸæŽ¨é€åˆ° main åˆ†æ”¯"
          fi

      - name: Create summary report
        run: |
          echo "ðŸ“Š åŒæ­¥å’Œå¤„ç†å®ŒæˆæŠ¥å‘Š" > sync_report.md
          echo "======================" >> sync_report.md
          echo "" >> sync_report.md
          echo "**å®Œæˆæ—¶é—´:** $(date)" >> sync_report.md
          echo "" >> sync_report.md
          echo "**åŒæ­¥æ¥æº:** https://github.com/qist/tvbox" >> sync_report.md
          echo "**ç›®æ ‡ä»“åº“:** https://github.com/city10666/tvbox-ayt" >> sync_report.md
          echo "" >> sync_report.md
          echo "**åº”ç”¨çš„è‡ªå®šä¹‰é…ç½®:**" >> sync_report.md
          echo "1. 6ä¸ªå›½å†…å¹³å°ç«™ç‚¹ä¼˜å…ˆæ˜¾ç¤º" >> sync_report.md
          echo "2. ç¬¬ä¸‰æ–¹è§£æžæŽ¥å£ä¿éšœ" >> sync_report.md
          echo "3. è·¯å¾„è½¬æ¢åˆ°ç”¨æˆ·ä»“åº“" >> sync_report.md
          echo "" >> sync_report.md
          echo "**ç”Ÿæˆçš„æ–‡ä»¶:**" >> sync_report.md
          echo "- dianshi.json (å¤„ç†åŽçš„å®Œæ•´é…ç½®)" >> sync_report.md
          echo "" >> sync_report.md
          echo "**ä½¿ç”¨è¯´æ˜Ž:**" >> sync_report.md
          echo "1. åœ¨TVBoxåº”ç”¨ä¸­é…ç½®ä»“åº“åœ°å€: https://raw.githubusercontent.com/city10666/tvbox-ayt/main/" >> sync_report.md
          echo "2. åŠ è½½ dianshi.json é…ç½®æ–‡ä»¶" >> sync_report.md
          echo "3. äº«å—å›½å†…å¹³å°å†…å®¹å’Œç¬¬ä¸‰æ–¹è§£æž" >> sync_report.md
          
          cat sync_report.md
